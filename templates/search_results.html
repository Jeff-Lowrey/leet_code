{% extends "base.html" %}

{% block title %}Search Results - Leet Code Learning Tool{% endblock %}

<!-- Stars Rendering Macro -->
{% macro render_stars(score) %}
{% set filled_stars = (score * 5)|round|int %}
{% set empty_stars = 5 - filled_stars %}
{% for i in range(filled_stars) %}‚òÖ{% endfor %}{% for i in range(empty_stars) %}‚òÜ{% endfor %}
{% endmacro %}

<!-- Result Card Macro -->
{% macro render_result_card(result, show_similarity=False) %}
<div class="result-card">
    <div class="result-card-header">
        <div class="result-card-title">
            <span class="problem-number">#{{ result.number }}</span>
            <a href="/solution/{{ result.category }}/{{ result.filename }}" class="problem-name">
                {{ result.name }}
            </a>
        </div>
        {% if show_similarity and result.similarity_score %}
        <div class="similarity-score">
            <div class="similarity-stars">
                {{ render_stars(result.similarity_score) }}
            </div>
            <div class="similarity-percentage">{{ (result.similarity_score * 100)|round|int }}%</div>
        </div>
        {% endif %}
    </div>

    <div class="result-card-meta">
        <span class="badge difficulty-{{ result.difficulty }}">{{ result.difficulty }}</span>
        <span class="badge category">{{ result.category_name }}</span>
        {% if result.time_complexity %}
        <span class="badge complexity">Time: {{ result.time_complexity }}</span>
        {% endif %}
        {% if result.space_complexity %}
        <span class="badge complexity">Space: {{ result.space_complexity }}</span>
        {% endif %}
    </div>

    {% if show_similarity and result.similarity_reasons %}
    <div class="similarity-reasons">
        <div class="similarity-reasons-title">Why it's similar:</div>
        <ul class="similarity-reasons-list">
            {% for reason in result.similarity_reasons %}
            <li>{{ reason }}</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="result-card-actions">
        <a href="/solution/{{ result.category }}/{{ result.filename }}" class="btn btn-sm btn-primary">
            View Solution
        </a>
        {% if mode != 'similar' %}
        <a href="/search?q={{ result.number }} difficulty={{ result.difficulty }}" class="btn btn-sm btn-secondary">
            Find Similar
        </a>
        {% endif %}
    </div>
</div>
{% endmacro %}

{% block content %}
<div class="search-results-page">
    <!-- Query Summary -->
    <div class="search-summary">
        <h1 class="search-summary-title">
            {% if mode == 'navigate' %}
                Problem #{{ query_info.number }}
            {% elif mode == 'similar' %}
                Problems Similar to #{{ reference_problem.number }}
            {% elif mode == 'name_search' %}
                Search Results for "{{ query_info.search_term }}"
            {% elif mode == 'filter' %}
                Filtered Problems
            {% else %}
                Search Results
            {% endif %}
        </h1>

        <!-- Original Query -->
        <div class="search-query-display">
            <span class="search-query-label">Query:</span>
            <code class="search-query-text">{{ query }}</code>
        </div>

        <!-- Reference Problem (for similarity search) -->
        {% if reference_problem %}
        <div class="reference-problem-card">
            <div class="reference-problem-header">
                <h3>Reference Problem</h3>
            </div>
            <div class="reference-problem-content">
                <div class="problem-title">
                    <span class="problem-number">#{{ reference_problem.number }}</span>
                    <a href="/solution/{{ reference_problem.category }}/{{ reference_problem.filename }}" class="problem-name">
                        {{ reference_problem.name }}
                    </a>
                </div>
                <div class="problem-meta">
                    <span class="badge difficulty-{{ reference_problem.difficulty }}">{{ reference_problem.difficulty }}</span>
                    <span class="badge category">{{ reference_problem.category_name }}</span>
                    {% if reference_problem.time_complexity %}
                    <span class="badge complexity">Time: {{ reference_problem.time_complexity }}</span>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Applied Filters -->
        {% if filters %}
        <div class="applied-filters">
            <span class="applied-filters-label">Filters:</span>
            <div class="applied-filters-list">
                {% for key, value in filters.items() %}
                <span class="filter-badge">
                    <span class="filter-key">{{ key }}</span>=<span class="filter-value">{{ value }}</span>
                </span>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Results Count -->
        <div class="results-count">
            Found <strong>{{ results|length }}</strong> problem{{ 's' if results|length != 1 else '' }}
        </div>
    </div>

    <!-- Results List -->
    {% if results %}
    <div class="search-results-list">
        {% if mode == 'similar' %}
            <!-- Similarity-based results with score grouping -->
            {% set high_similarity = [] %}
            {% set medium_similarity = [] %}
            {% set low_similarity = [] %}

            {% for result in results %}
                {% if result.similarity_score >= 0.8 %}
                    {% set _ = high_similarity.append(result) %}
                {% elif result.similarity_score >= 0.5 %}
                    {% set _ = medium_similarity.append(result) %}
                {% else %}
                    {% set _ = low_similarity.append(result) %}
                {% endif %}
            {% endfor %}

            <!-- High Similarity -->
            {% if high_similarity %}
            <div class="similarity-group">
                <h2 class="similarity-group-title">
                    <span class="similarity-icon">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                    Very Similar ({{ high_similarity|length }})
                </h2>
                <div class="results-grid">
                    {% for result in high_similarity %}
                        {{ render_result_card(result, show_similarity=True) }}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Medium Similarity -->
            {% if medium_similarity %}
            <div class="similarity-group">
                <h2 class="similarity-group-title">
                    <span class="similarity-icon">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</span>
                    Moderately Similar ({{ medium_similarity|length }})
                </h2>
                <div class="results-grid">
                    {% for result in medium_similarity %}
                        {{ render_result_card(result, show_similarity=True) }}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Low Similarity -->
            {% if low_similarity %}
            <div class="similarity-group">
                <h2 class="similarity-group-title">
                    <span class="similarity-icon">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</span>
                    Somewhat Similar ({{ low_similarity|length }})
                </h2>
                <div class="results-grid">
                    {% for result in low_similarity %}
                        {{ render_result_card(result, show_similarity=True) }}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

        {% else %}
            <!-- Standard results list -->
            <div class="results-grid">
                {% for result in results %}
                    {{ render_result_card(result, show_similarity=False) }}
                {% endfor %}
            </div>
        {% endif %}
    </div>

    {% else %}
    <!-- No Results State -->
    <div class="no-results">
        <div class="no-results-icon">üîç</div>
        <h2 class="no-results-title">No results found</h2>
        <p class="no-results-description">
            We couldn't find any problems matching your search criteria.
        </p>
        <div class="no-results-suggestions">
            <h3>Try:</h3>
            <ul>
                <li>Using a different problem number</li>
                <li>Searching by problem name (e.g., "palindrome", "binary")</li>
                <li>Adjusting your filters (e.g., "difficulty=easy")</li>
                <li>Browsing <a href="/">all categories</a></li>
            </ul>
        </div>
        <div class="no-results-actions">
            <a href="/" class="btn btn-primary">Browse All Problems</a>
            <a href="/difficulty" class="btn btn-secondary">View by Difficulty</a>
        </div>
    </div>
    {% endif %}

    <!-- Search Tips -->
    <div class="search-tips">
        <h3>Search Tips</h3>
        <ul>
            <li><code>443</code> - Go directly to problem #443</li>
            <li><code>palindrome</code> - Search problems by name</li>
            <li><code>443 difficulty=easy</code> - Find similar easy problems to #443</li>
            <li><code>difficulty=medium category=graphs</code> - Filter medium graph problems</li>
            <li><code>complexity=O(n)</code> - Find problems with linear time complexity</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/pages/search-results.css') }}">
{% endblock %}
