{% extends "base.html" %}

{% block title %}All Difficulties - Leet Code Learning Tool{% endblock %}

{% block content %}
<header class="page-header">
    <nav class="breadcrumb">
        <a href="/">Home</a> / <span>All Difficulties</span>
    </nav>
    <h1>Problems by Difficulty</h1>
    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
        <p class="stats">{{ total_count }} total solution{% if total_count != 1 %}s{% endif %} — {% for difficulty_name, difficulty_data in difficulties.items() %}{{ difficulty_name }}: {{ difficulty_data.count }}{% if not loop.last %}, {% endif %}{% endfor %}</p>
        <button id="toggle-all-sections" class="btn btn-secondary">Collapse All</button>
    </div>
    <div style="margin-top: 0.5rem;">
        <p class="stats" id="complexity-stats">Top complexities — Loading...</p>
    </div>
</header>

{% for difficulty_name, difficulty_data in difficulties.items() %}
<section class="solutions-list difficulty-section" id="{{ difficulty_name.lower() }}">
    <details open>
        <summary>
            <h2>{{ difficulty_name }} ({{ difficulty_data.count }} problem{% if difficulty_data.count != 1 %}s{% endif %}) — <span class="section-breakdown" data-difficulty="{{ difficulty_name.lower() }}">Loading...</span></h2>
        </summary>
        <div class="solutions-grid">
            {% for item in difficulty_data.solutions %}
            <a href="{{ url_for('solution_view', category=item.category, filename=item.solution.filename.replace('.py', '')) }}" class="solution-card" data-category="{{ item.category }}" data-difficulty="{{ difficulty_name.lower() }}">
                {% if item.solution.number %}
                <span class="problem-number">#{{ item.solution.number }}</span>
                {% endif %}
                <div class="solution-card-header">
                    <h3>{{ item.solution.name }}</h3>
                    <span class="category-label-inline">{{ item.category_name }}</span>
                </div>
                <div class="solution-badges">
                    {% if item.solution.time_complexity or item.solution.space_complexity %}
                    <span class="complexity-badge">
                        {{ item.solution.time_complexity or '?' }} / {{ item.solution.space_complexity or '?' }}
                    </span>
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    </details>
</section>
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleBtn = document.getElementById('toggle-all-sections');
    const allDetails = document.querySelectorAll('.difficulty-section details');
    let allExpanded = true;

    toggleBtn.addEventListener('click', function() {
        allExpanded = !allExpanded;
        allDetails.forEach(details => {
            details.open = allExpanded;
        });
        toggleBtn.textContent = allExpanded ? 'Collapse All' : 'Expand All';
    });

    // Fetch overall complexity stats for header
    fetch('/api/stats/complexity')
        .then(r => r.json())
        .then(complexityStats => {
            // Overall complexity stats for header
            const sortedComplexities = Object.entries(complexityStats)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 7);

            const complexityText = sortedComplexities
                .map(([pattern, count]) => `${pattern}: ${count}`)
                .join(', ');

            const total = sortedComplexities.reduce((sum, [_, count]) => sum + count, 0);
            const grandTotal = Object.values(complexityStats).reduce((sum, count) => sum + count, 0);
            const remaining = grandTotal - total;

            let displayText = `Top complexities — ${complexityText}`;
            if (remaining > 0) {
                displayText += `, Other: ${remaining}`;
            }

            document.getElementById('complexity-stats').textContent = displayText;
        })
        .catch(error => {
            console.error('Failed to load overall complexity stats:', error);
            document.getElementById('complexity-stats').textContent = 'Complexity breakdown unavailable';
        });

    // Fetch per-difficulty complexity breakdowns
    const difficultyLevels = ['easy', 'medium', 'hard'];
    difficultyLevels.forEach(difficulty => {
        fetch(`/api/stats/complexity/difficulty/${difficulty}`)
            .then(r => r.json())
            .then(complexityCounts => {
                // Sort and take top 5
                const sorted = Object.entries(complexityCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                const text = sorted.map(([pattern, count]) => `${pattern}: ${count}`).join(', ');

                const totalShown = sorted.reduce((sum, [_, count]) => sum + count, 0);
                const grandTotal = Object.values(complexityCounts).reduce((sum, count) => sum + count, 0);
                const remainingForDiff = grandTotal - totalShown;

                let finalText = text;
                if (remainingForDiff > 0) {
                    finalText += `, Other: ${remainingForDiff}`;
                }

                const span = document.querySelector(`.section-breakdown[data-difficulty="${difficulty}"]`);
                if (span) {
                    span.textContent = finalText;
                }
            })
            .catch(error => {
                console.error(`Failed to load complexity stats for ${difficulty}:`, error);
            });
    });
});
</script>
{% endblock %}
